---
title: "Assignment2"
author: "Manying"
date: "09/10/2017"
output: html_document
---

```{r}
source("functions.R")
```

## Exercise_1a

```{r}
print(sum_column(iris, "Sepal.Length"))
print(sum_column(iris, "Species"))
print(sum_column(warpbreaks, "breaks"))

```

## Exercise_1b

```{r}
print(my_sum(iris$Sepal.Length))
print(my_sum(iris$Species))
print(my_sum(warpbreaks$breaks))
```

## Exercise_1c

```{r}
print(sum_divided_by(iris$Sepal.Length, 12))
print(sum_divided_by(iris$Species, 22))
print(sum_divided_by(iris$Sepal.Length, "Not numeric"))
print(sum_divided_by(warpbreaks$breaks, -12))
```

## Exercise_1d

```{r}
print(my_mean(iris$Sepal.Length))
print(my_mean(iris$Species))
print(my_mean(warpbreaks$breaks))
```

## Exercise_2a

```{r}
print(grouped_violin_plot(iris, "Sepal.Length", "Species"))
```

## Exercise_2b

```{r}
p <- grouped_violin_plot(iris, "Sepal.Length", "Species") # initialize p as object
# YOUR CODE HERE: Change the colour scheme for the interior of the three violin plots
p <- p + ggplot2::scale_fill_manual(values = c("blue", "white", "darkgrey")) # modify p with manual filled color
# to anything else at all.
# YOUR CODE HERE: Add a main title that says "Iris data".
p <- p + ggplot2::labs(title="Iris data") # modify p with adding title. PS: I did it already in Exercise_2a
print(p)
```

## Exercise_3a

```{r}
difference_in_medians(iris, "Sepal.Width", "Species", "versicolor", "virginica")
difference_in_medians(iris, "Sepal.Width", "Species", "virginica", "virginica")
```

## Exercise_3b

```{r}
iris$Sepal.Width[1:10]
if(!exists(".Random.seed")) set.seed(NULL)
previous_seed <- .Random.seed
set.seed(1)
randomize(iris, "Sepal.Width")$Sepal.Width[1:10]
randomize(iris, "Species")$Species[1:10]
randomize(iris, "Species")$Sepal.Width[1:10]
set.seed(previous_seed)
```

## Exercise_3c

```{r}
if(!exists(".Random.seed")) set.seed(NULL)
previous_seed <- .Random.seed
set.seed(1)
ptest_1 <- permutation_twogroups(iris, "Sepal.Width", "Species", "versicolor",
"virginica", difference_in_medians, n_samples=10)
ptest_2 <- permutation_twogroups(iris, "Sepal.Width", "Species", "versicolor",
"virginica", difference_in_medians, n_samples=10)
ptest_3 <- permutation_twogroups(randomize(iris, "Sepal.Width"), "Sepal.Width",
"Species", "versicolor", "virginica",
difference_in_medians, n_samples=10)
set.seed(previous_seed)
print(ptest_1)
print(ptest_2)
print(ptest_3)
print(ptest_3$observed)
print(ptest_3[["observed"]])
```

## Exercise_3d

I did experiments to see how it changes if I did `d_fake <- randomize(d,grouping_var)`. And I had this:

> $observed
[1] -0.2
$permuted
 [1] 0.00 0.10 0.00 0.00 0.00 0.05 0.00 0.00 0.00 0.05
$observed
[1] -0.2
$permuted
 [1]  0.10  0.00  0.00  0.00  0.00  0.00 -0.05 -0.10  0.05  0.10
$observed
[1] 0
$permuted
 [1]  0.10  0.00  0.00 -0.10 -0.10  0.10  0.00  0.00  0.10  0.05
 
 
It did change my result and my permuted median difference is generally much more moved to right compared to the ones generated by `d_fake <- randomize(d,var)`. Another observation is that the precedent fake data has more variants in its permuted median difference. So by now I'd like to say that this change matters. But we can still wait for further experiments to give the judgement.

## Exercise_3e

```{r, cache=T}
if(!exists(".Random.seed")) set.seed(NULL)
previous_seed <- .Random.seed
set.seed(1)
ptest <- permutation_twogroups(iris, "Sepal.Width", "Species", "versicolor",
"virginica", difference_in_medians)
set.seed(previous_seed)
```

```{r}
ptest_d <- tibble::as_tibble(ptest["permuted"]) # get the value (the list of) "permuted" in ptest then change it to be a tibble
ptest_observe <- as.numeric(ptest["observed"]) # get the value of "observed" in ptest then treat it like it's numeric
#print(ptest_observe)
# YOUR CODE HERE: plot a histogram with a vertical line at the observed value
p <- ggplot2::ggplot(ptest_d, ggplot2::aes_string(x="permuted",y="..count.."))+ # define the x and y
    ggplot2::geom_histogram(colour="skyblue",fill="white")+ # tell R clearly that the object is a histogram
    ggplot2::geom_vline(xintercept=ptest_observe, # draw the reference line, remember that "xintercept=" should be numeric value
                                 colour="skyblue")

print(p)
```

As we can see, the original median difference is at -0.2 which is much left than the permuted ones, with notice that the majority permuted median difference is at 0.0, which indicates furthur the distance with the original one. So we have good reason to say that, the Hypothesis for "the groupes are the same in terms of Sepal width" is not perminent. If they are same, the permuted data which is generated by treating the data as if these groupes have no difference in terms of these values, will be very closed to the original line. It is because that they are in fact not same in terms of values that they have this different performance in the median difference. 

## Exercise_3f

```{r}
if(!exists(".Random.seed")) set.seed(NULL)
previous_seed <- .Random.seed
set.seed(1)
ptest_new <- permutation_twogroups(iris, "Sepal.Width", "Species", "versicolor",
"virginica", new_test_statistic)
set.seed(previous_seed)
```

```{r}
#print(ptest_new[1:10])
ptest_new_d <- tibble::as_tibble(ptest_new["permuted"]) # get the value (the list of) "permuted" in ptest then change it to be a tibble
ptest_new_observe <- as.numeric(ptest_new["observed"]) # get the value of "observed" in ptest then treat it like it's numeric
#print(ptest_observe)
# YOUR CODE HERE: plot a histogram with a vertical line at the observed value
p_new <- ggplot2::ggplot(ptest_new_d, ggplot2::aes_string(x="permuted",y="..count.."))+ # define the x and y
    ggplot2::geom_histogram(colour="skyblue",fill="white")+ # tell R clearly that the object is a histogram
    ggplot2::geom_vline(xintercept=ptest_new_observe, # draw the reference line, remember that "xintercept=" should be numeric value
                                 colour="skyblue")

print(p_new)
```


We can see that these histograms have changed. If we are certain that the hypothesis A is wrong by talking about the histogram of "median difference", we have not so much certainty to say it when we talk about the second one. This time the reference line is no longer "outside" the fields but is found at the left among with other permuted statistical data. Notice that last time we have only 200 permuted data along with the reference line (0.2) but about 5800 (0.0), the difference is very considerable. But now when we test the difference of max width of their sepal, the difference between original data and permuted data is much more moderate. The reference line (about 0.6) has about 700 neighbor permuted cases and the most seen permuted max difference are about 1500 cases. Again we have no longer a strong reason to say that hypothesis A is wrong.

Besides, this change could be caused by the test criteria. Maybe in the nature there're a much more visible difference between the width of the most of versicolors and the most of virginicas than their limit of how much width could a versicolor/virginica have.


## Exercise_3g

```{r}
permutation_pvalue_right <- function(p) {
n_above <- sum(p$permuted >= p$observed) # this is to know how many cases situated at the right of the observed one
# it's not the value of permuted stats, it's the sum of "True" and let's say True==1, so: if the value of p$permuted >= p$observed, we get 1, and sum these 1 we get the number of cases
n_samples <- length(p$permuted)
return((n_above + 1)/(n_samples + 1)) # so more this returned value closed to 1, more permuted cases are situated at the right of observed case.
}
permutation_pvalue_left <- function(p) {
n_below <- sum(p$permuted <= p$observed)
n_samples <- length(p$permuted)
return((n_below + 1)/(n_samples + 1))
}

print(permutation_pvalue_right(ptest))
print(permutation_pvalue_left(ptest))
```

Let's take the example of Iris flowers as above. We examined the difference of mediam in our observed stats is -0.2 and we permuted by default 9999 fake cases in pretending that the two groups *"versicolor"* and *"virginica"* are the same in terms of their *Sepal Width*.

We'd predict that the difference in the medians statistic would be extreme on the right side, that's to say the `pvalue_right` is very small, if our **Hypothesis B** is that the two groups are drawn from very different sources of variability and the permuted differences in the medians are in majority below the one of observed value. That's to say, the *"versicolor"* has a bigger median Sepal Width than *"virginica"* is not just an observation. In contrary, the two groups did have difference in their variability.

In this case, we will use `pvalue_right` to see if it's really small and the `pvalue_right` will tell us how many differences in medians are superior than our observed sample. If it's the case, we will see that the observed difference in medians is "outside" and at the very right of the edge of permuted cases (most permuted differences in median is smaller than the observed one. So the permutation that based on **Hypothesis A** is not perminent to the fact, which in reverse, prove that **Hypothesis A** is not the right case). 

```{r}
iris_subset_1 <- iris[c(89:94, 108:112),]
iris_subset_2 <- iris[88:114,]

ptest_new_1 <- permutation_twogroups(iris_subset_1, "Sepal.Width", "Species", "versicolor",
"virginica", difference_in_medians)
ptest_new_2 <- permutation_twogroups(iris_subset_2, "Sepal.Width", "Species", "versicolor",
"virginica", difference_in_medians)

```

```{r}
iris_subset_1 <- iris[c(89:94, 108:112),]
iris_subset_2 <- iris[88:114,]
print(iris_subset_1)
print(iris_subset_2)
```

```{r}
ptest_new_d_1 <- tibble::as_tibble(ptest_new_1["permuted"]) # get the value (the list of) "permuted" in ptest then change it to be a tibble
ptest_new_observe_1 <- as.numeric(ptest_new_1["observed"]) # get the value of "observed" in ptest then treat it like it's numeric
ptest_new_d_2 <- tibble::as_tibble(ptest_new_2["permuted"]) # get the value (the list of) "permuted" in ptest then change it to be a tibble
ptest_new_observe_2 <- as.numeric(ptest_new_2["observed"]) # get the value of "observed" in ptest then treat it like it's numeric

p <- ggplot2::ggplot(ptest_d, ggplot2::aes_string(x="permuted",y="..count.."))+ # define the x and y
    ggplot2::geom_histogram(colour="skyblue",fill="skyblue")+ # tell R clearly that the object is a histogram
    ggplot2::geom_vline(ggplot2::aes(xintercept=ptest_new_1[["observed"]]), lwd=0.5, color="skyblue") +
  ggplot2::geom_vline(ggplot2::aes(xintercept=ptest_new_2[["observed"]]), lwd=0.5, color="darkgrey") +
  ggplot2::geom_vline(ggplot2::aes(xintercept=ptest[["observed"]]), lwd=0.5, color="pink")+
    ggplot2::xlim(-0.6,0.6)
print(p)

p_new_1 <- ggplot2::ggplot(ptest_new_d_1, ggplot2::aes_string(x="permuted",y="..count.."))+ # define the x and y
    ggplot2::geom_histogram(colour="grey",fill="grey")+ # tell R clearly that the object is a histogram
    ggplot2::geom_vline(ggplot2::aes(xintercept=ptest_new_1[["observed"]]), lwd=0.5, color="skyblue") +
  ggplot2::geom_vline(ggplot2::aes(xintercept=ptest_new_2[["observed"]]), lwd=0.5, color="darkgrey") +
  ggplot2::geom_vline(ggplot2::aes(xintercept=ptest[["observed"]]), lwd=0.5, color="pink")+
    ggplot2::xlim(-0.6,0.6)

p_new_2 <- ggplot2::ggplot(ptest_new_d_2, ggplot2::aes_string(x="permuted",y="..count.."))+ # define the x and y
    ggplot2::geom_histogram(colour="pink",fill="pink")+ # tell R clearly that the object is a histogram
    ggplot2::geom_vline(ggplot2::aes(xintercept=ptest_new_1[["observed"]]), lwd=0.5, color="skyblue") +
  ggplot2::geom_vline(ggplot2::aes(xintercept=ptest_new_2[["observed"]]), lwd=0.5, color="darkgrey") +
  ggplot2::geom_vline(ggplot2::aes(xintercept=ptest[["observed"]]), lwd=0.5, color="red")+
    ggplot2::xlim(-0.6,0.6)

print(p_new_1)
print(p_new_2)
```

```{r}
print(permutation_pvalue_right(ptest_new_1))
print(permutation_pvalue_right(ptest_new_2))
```

We shall take a look on the three histograms that we get. Apparently, the first one (skyblue one) is what we have seen, it has a distribution more concentrated, the boxes gallery around the x=0.0 and it's in a form almost symetry. The permuted values vary in the range of about -0.25 to 0.25. Even compared to the pink line, we could say that the permuted values are at the right of observed ones. Compared to other two histograms, the blue one has very little difference in median. 

The grey one is more distributed and it has even a blank gap in its middle. The permuted datas accumute on the two sides of the histogram and it seems that we have considerable exemples who have big difference of median. Compared to the three lines, over half of the examples are at the right side but in comparison of other two permuted cases, left hand and right hand have less difference in the number.

The pink one is more generally distributed in comparison of other two. We consider a large range of x values from -0.6 to 0.6, we are not in the symetry mirror but there's no really gap in the middle. But still the most permuted examples are at the right hand of observed line.

I think the difference among these histograms is caused by the variety of their data. Apparently, in the first one we take a look of all the data that we have. And the second one only 11 data in which there's 6 versicolor and 5 virginica and third one 27 data in which 13 versicolor and 14 virginica. I guess the second sample retrieve just the very data where there's more big difference in the medians of two groups and since the sample is rather small, the influence is zoomed in, the permuted examples are so that in the distribution of two extreme sides. Simarly, the third sample has more data, and in which we have big difference in the medians as well as little difference. So the variety of the third one is bigger than the second one.

I think the conclusion is more like that the two groups of observations don’t come from the same source of variability. Even though we see the pvalue 0.77, different from 0.99 (the original permuted one), I think we cannot consider that 0.77 is enoughed closed to 0.5 (which will defend the same source of variability hypothesis), since, like I argued just now, this number comes from a small sample who's less representative in comparison to the whole sample. Besides, the other pvalue 0.94 also defends to the extent that 2/3 permuted samples that we have refers to that the two groups of observations don’t come from the same source of variability.